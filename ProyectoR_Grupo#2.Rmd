---
title: "ProyectoR_Grupo#2"
author: "Stephany Pachay"
date: "2023-08-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### **Setup**

**Load packages**

Para el análisis de datos del dataset se cargaron los siguientes paquetes:

```{r}
library(openxlsx)
library(magrittr)
library(tidyverse)
library(tibble)
library(tidyr)
library(ggplot2)
```

**Load Data**

## **Introducción**

En el presente estudio, analizaremos los principales indicadores o ratios financieros de diversas empresas de nuestro país, con la finalidad de determinar su situación, esto es de vital importancia ya que permite proyectarnos a una mejora en la toma de decisiones.

El análisis financiero presentado fue realizado con una valiosa herramienta de análisis de datos, R, esta herramienta nos ofrece un entorno de desarrollo interactivo donde facilita la exploración y manipulación de los datos, gracias a la misma a más de realizar el análisis cuantitativo podemos visualizar y presentar nuestros resultados.

Al estar evaluando empresas con diferentes actividades económicas, los objetivos pueden varias de acuerdo a su naturaleza, sin embargo, nuestro análisis se enfoca principalmente en liquidez, solvencia y rentabilidad, por lo que nos hemos propuesto los siguientes objetivos.

### **Objetivo General**

Evaluar la liquidez y solvencia de las empresas para cumplir sus obligaciones financieras en el corto y largo plazo, con la finalidad de generar de manera sostenible una posición dentro del mercado ecuatoriano.

### **Objetivos específicos**

1.  Determinar el nivel de endeudamiento del activo de las microempresas, pequeñas empresas y grandes empresas.
2.  Comparar la liquidez de las empresas en base al número de trabajadores.
3.  Describir el top 10 de las empresas con mayor apalancamiento.

### **Metodología**

La Base a trabajar es balance_2014.xlsx, que consiste en 347 variables y 47033 observaciones junto con . A continuación se presentan las variables de dicha base.

```{r}
balance_2014<-read.xlsx("Data/balances_2014.xlsx")
ciiu<-read.xlsx("Data/ciiu.xlsx")
cias<-read.xlsx("Data/cias_codebook.xlsx")
balance_2014<-tibble(balance_2014)
```

Los datos están compuestos por columnas tales como: expediente, ruc, nombre_cia, situación, tipo, fecha_const, país, provincia, cantón, ciudad, ciiu4_nivel1, ciiu4_nivel6, trab_direc, trab_admin, trab_produc, trab_otros, tamaño, año, entre otras cientos de variables.

## Análisis preliminar y preparación de los datos

La base se compone de variables numéricas y categóricas.

### Selección y Limpieza de datos

En esta sección se creará la base, y luego se la depurará para poder identificar aquellos datos que se encuentran incompletos, incorrectos, inexactos, no pertinentes,etc. De tal manera que podamos substituir, modificar o eliminar estos datos con el fin de obtener una base de datos de calidad y hacer un análisis correcto.

```{r}
balance<-
  balance_2014 %>%
  inner_join(ciiu, by=c("ciiu4_nivel1"="CODIGO")) %>% 
  inner_join(ciiu, by=c("ciiu4_nivel6"="CODIGO"))%>% 
  mutate(liquidez_corriente=v345/v539,endeu_activo=v599/v499,
         ende_patrimo=v599/v698,ende_activo_fijo=v698/v498, 
         apalancamiento=v499/v698) %>% 
  rename(actividad=DESCRIPCION.x,
         subactividad=DESCRIPCION.y) %>% 
  select(nombre_cia, situacion, tipo, pais, provincia, canton, ciudad,fecha_const,
         tamanio, actividad ,subactividad,trab_direc,trab_admin,
         liquidez_corriente,endeu_activo,ende_patrimo,
         ende_activo_fijo,apalancamiento) %>% 
  mutate(actividad=as.factor(actividad),
         subactividad=as.factor(subactividad),
         situacion=as.factor(situacion),
         tipo=as.factor(tipo))
```

Con la base de datos obtenida, creamos una tabla resumiendo el número total de empresas por actividad económica y por actividad económica por cada cantón:

```{r}
empresas_por_canton <- balance %>% group_by(actividad,canton) %>% summarise(total_empresas=n())
empresas_por_canton
```

En esta parte del proyecto se realizó la depuración de la base, en donde también se usó *function.*

```{r}
cantidad_de_NA <- sum(is.na(balance))
balance<-balance[is.finite(balance$liquidez_corriente), ]
balance<-balance[is.finite(balance$apalancamiento), ]
```

```{r}
finitos <- function(data, columna) {
  data_filtrado <- data[is.finite(data[[columna]]), ]
  return(data_filtrado)
}
```

```{r}
balance<-finitos(balance,"endeu_activo") 
balance<-finitos(balance,"ende_patrimo") 
balance<-finitos(balance,"ende_activo_fijo") 
colSums(is.na(balance))
base1 <- na.omit(balance)
colSums(is.na(base1))
```

### Indicadores Financieros

En esta sección se muestra gráficamente el comparativo de los indicadores financieros de liquidez y solvencia por situación y provincia.

```{r}
attach(balance)

activas<-balance %>% filter(situacion=="ACTIVA")
impute_outliers <- function(x, removeNA = TRUE){
  quantiles <- quantile(x, c(0.05, 0.95), na.rm = removeNA)
  x[x<quantiles[1]] <- mean(x, na.rm = removeNA)
  x[x>quantiles[2]] <- median(x, na.rm = removeNA)
  x
}
activas$liquidez_corriente<-impute_outliers(activas$liquidez_corriente)
```

```{r}
plot(activas$liquidez_corriente)
ggplot(activas, aes(x=fecha_const, y=liquidez_corriente, color = provincia, group=provincia))   +
  geom_line() +
  geom_hline(data = activas %>% group_by(provincia) %>% summarise(ymin = quantile(liquidez_corriente, 0.25), ymed = median(liquidez_corriente), ymax = quantile(liquidez_corriente, 0.75)),
             aes(yintercept = ymin), linetype = "dashed", color = "red") +
  geom_hline(data = activas %>% group_by(provincia) %>% summarise(ymin = quantile(liquidez_corriente, 0.25), ymed = median(liquidez_corriente), ymax = quantile(liquidez_corriente, 0.75)),
             aes(yintercept = ymed), linetype = "dashed", color = "purple") +
  geom_hline(data = activas %>% group_by(provincia) %>% summarise(ymin = quantile(liquidez_corriente, 0.25), ymed = median(liquidez_corriente), ymax = quantile(liquidez_corriente, 0.75)),
             aes(yintercept = ymax), linetype = "dashed", color = "black") +
  labs(title = "Comparativo de Indicadores de Liquidez por situacion ACTIVA y provincia",
       x = "Fecha constitución",
       y = "Liquidez") +
  facet_wrap(~provincia)+
  theme_minimal()+
  theme(legend.position = "none")
```

```{r}
activas$apalancamiento<-impute_outliers(activas$apalancamiento)
plot(activas$apalancamiento)
ggplot(activas, aes(x=fecha_const, y=apalancamiento, color = provincia, group=provincia))   +
  geom_line() +
  geom_hline(data = activas %>% group_by(provincia) %>% summarise(ymin = quantile(apalancamiento, 0.25), ymed = median(apalancamiento), ymax = quantile(apalancamiento, 0.75)),
             aes(yintercept = ymin), linetype = "dashed", color = "red") +
  geom_hline(data = activas %>% group_by(provincia) %>% summarise(ymin = quantile(apalancamiento, 0.25), ymed = median(apalancamiento), ymax = quantile(apalancamiento, 0.75)),
             aes(yintercept = ymed), linetype = "dashed", color = "purple") +
  geom_hline(data = activas %>% group_by(provincia) %>% summarise(ymin = quantile(apalancamiento, 0.25), ymed = median(apalancamiento), ymax = quantile(apalancamiento, 0.75)),
             aes(yintercept = ymax), linetype = "dashed", color = "black") +
  labs(title = "Comparativo de Indicadores de Apalancamiento por situacion ACTIVA y provincia",
       x = "Fecha constitución",
       y = "apalancamiento") +
  facet_wrap(~provincia)+
  theme_minimal()+
  theme(legend.position = "none")
```

Así mismo, se podrá mostrar gráficamente el comparativo de los indicadores financieros de liquidez y solvencia por tipo de empresa.

```{r}
ggplot(activas, aes(x=fecha_const, y=liquidez_corriente, color = tipo, group=tipo))   +
  geom_line() +
  geom_hline(data = activas %>% group_by(tipo) %>% summarise(ymin = quantile(liquidez_corriente, 0.25), ymed = median(liquidez_corriente), ymax = quantile(liquidez_corriente, 0.75)),
             aes(yintercept = ymin), linetype = "dashed", color = "red") +
  geom_hline(data = activas %>% group_by(tipo) %>% summarise(ymin = quantile(liquidez_corriente, 0.25), ymed = median(liquidez_corriente), ymax = quantile(liquidez_corriente, 0.75)),
             aes(yintercept = ymed), linetype = "dashed", color = "purple") +
  geom_hline(data = activas %>% group_by(tipo) %>% summarise(ymin = quantile(liquidez_corriente, 0.25), ymed = median(liquidez_corriente), ymax = quantile(liquidez_corriente, 0.75)),
             aes(yintercept = ymax), linetype = "dashed", color = "black") +
  labs(title = "Comparativo de Indicadores de Liquidez por situacion ACTIVA y tipo",
       x = "Fecha constitución",
       y = "Liquidez") +
  facet_wrap(~tipo)+
  theme_minimal()+
  theme(legend.position = "none")
```

```{r}
ggplot(activas, aes(x=fecha_const, y=apalancamiento, color = tipo, group=tipo))   +
  geom_line() +
  geom_hline(data = activas %>% group_by(tipo) %>% summarise(ymin = quantile(apalancamiento, 0.25), ymed = median(apalancamiento), ymax = quantile(apalancamiento, 0.75)),
             aes(yintercept = ymin), linetype = "dashed", color = "red") +
  geom_hline(data = activas %>% group_by(tipo) %>% summarise(ymin = quantile(apalancamiento, 0.25), ymed = median(apalancamiento), ymax = quantile(apalancamiento, 0.75)),
             aes(yintercept = ymed), linetype = "dashed", color = "purple") +
  geom_hline(data = activas %>% group_by(tipo) %>% summarise(ymin = quantile(apalancamiento, 0.25), ymed = median(apalancamiento), ymax = quantile(apalancamiento, 0.75)),
             aes(yintercept = ymax), linetype = "dashed", color = "black") +
  labs(title = "Comparativo de Indicadores de Apalancamiento por situacion ACTIVA y tipo",
       x = "Fecha constitución",
       y = "Liquidez") +
  facet_wrap(~tipo)+
  theme_minimal()+
  theme(legend.position = "none")
```

## **Análisis de Resultados**

#### **¿El endeudamiento del activo fue mayor en empresas micro + pequeñas vs. grandes?**

El nivel de endeudamiento del activo es mayor en las empresas micro y pequeñas a comparación de las empresas grandes, esto puede ser por diversas razones, es importante resaltar que el nivel de endeudamiento depende de factores como su industria, estructura de costos, flujos de efectivo, nivel de riesgo, objetivos, entre otros.

Pero de forma general se debe a que las empresas pequeñas tienen un limitado acceso de capital, por lo que tiene que depender de mayor número de préstamos y créditos bancarios con la finalidad de continuar sus operaciones y proyectos.

Estas empresas son percibidas en su mayoría como riesgosas por el hecho del tamaño, menor tiempo en el mercado y menor número de recursos, todas estas limitaciones hacen que las condiciones para préstamos sean muy restringidas y con intereses muy altos, lo que sigue incrementando el nivel de endeudamiento.

Otro aspecto importante que justifica el mayor nivel de endeudamiento es que su ciclo de efectivo es más extenso, ya que se tardan más días en convertir sus activos en efectivo.

```{r}
micro_pequeña <- balance %>%
  filter(tamanio%in% c("MICRO", "PEQUEÑA")) %>%
  summarise(Promedio1 = mean(endeu_activo))
micro_pequeña
```

```{r}
grande <- balance %>%
  filter(tamanio%in% c("GRANDE")) %>%
  summarise(Promedio2 = mean(endeu_activo))
grande
```

```{r}
comparativo<- tibble(Tamaño=c("Micro+Pequeña","Grande"),
                     Media=c(micro_pequeña$Promedio1,grande$Promedio2))
comparativo
```

```{r}
ggplot(comparativo, aes(x = Tamaño, y = Media, fill = Tamaño)) +
  geom_bar(stat = "identity") +
  labs(title = "Comparación de Endeudamiento del Activo entre Micro + Pequeña y Grande",
       x = "Tamaño de Empresa", y = "Valor de Endeudamiento del Activo") +
  theme_minimal()
```

#### ¿La liquidez por tipo de compañía es diferente entre aquellas empresas que tienen más de 60 trabajadores directos y que cuenta con 100 a 800 trabajadores administrativos?

La liquidez varía según el tipo de empresa. Y como se puede observar en los datos de liquidez corriente, no se encuentran diferencias significativas, por ende no se puede afirmar que existan diferencias en la liquidez entre los grupos analizados.

```{r}
liquidez_compania<- balance %>% select(tipo,trab_direc,trab_admin,liquidez_corriente) %>% 
  filter(trab_direc>60,trab_admin>=100,trab_admin<=800)
liquidez_compania
```

```{r}
liquidez_compania %>% group_by(tipo)%>% 
  summarise(Promedio3 = mean(liquidez_corriente))
```

```{r}
ggplot(liquidez_compania, aes(x = tipo, y = liquidez_corriente, fill = tipo)) +
  geom_jitter(alpha=1,color="gray")+
  geom_boxplot(alpha=0.1) +
  labs(title = "Comparación de Liquidez por Tipo de Compañía",
       x = "Tipo de Compañía", y = "Liquidez") +
  theme_minimal()+
  theme(legend.position = "none")
```

#### Describe el top 10 de empresas con mayor apalancamiento.

El nivel de apalancamiento hace referencia a la deuda externa que genero la empresa para incrementar su rendimiento y maximizar ganancias.

El apalancamiento es positivo cuando la empresa esta en la capacidad de generar ingresos suficientes para cubrir el pago de la deuda y los intereses correspondientes, pero por otro lado tenemos el apalancamiento negativo, este se da cuando los ingresos no son suficientes para cubrir la deuda, esto conlleva a un riesgo de quiebra,

Por lo tanto es importante que las empresas analicen cuidadosamente su capacidad de pago y el nivel de riesgo antes de utilizar el apalancamiento, para que no se vea afectada su estabilidad financiera.

```{r}
balance %>% select(nombre_cia,apalancamiento) %>% 
  arrange(desc(apalancamiento)) %>% 
  head(10)
```

## Conclusión
